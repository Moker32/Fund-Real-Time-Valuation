# 基金实时估值 TUI 应用设计文档

**创建日期**: 2026-02-03

## 项目概述

基于 Python + Textual 的终端界面应用，帮助用户实时监控基金估值、管理自选和持仓，同时支持大宗商品行情和财经新闻。

## 技术栈

- **UI 框架**: Textual
- **数据获取**: requests, akshare
- **数据存储**: SQLite / YAML
- **图表**: matplotlib（ASCII 或终端图片显示）

## 数据源

### 基金数据源

| 数据源 | 接口 | 优先级 | 状态 |
|--------|------|--------|------|
| 天天基金/新浪 | `fundgz.1234567.com.cn` | 1 | 主力 |
| 东方财富 | `fund.eastmoney.com` | 2 | 备用 |

### 商品数据源

| 商品 | 数据源 | 接口/库 |
|------|--------|---------|
| 黄金(XAU/USD) | Alpha Vantage | `CURRENCY_EXCHANGE_RATE` |
| 黄金(Au99.99) | AKShare | `spot_gold_sge()` |
| WTI原油 | AKShare | `futures_wti_price()` |
| 布伦特原油 | AKShare | `futures_brent_price()` |
| 白银 | Alpha Vantage | `CURRENCY_EXCHANGE_RATE` |

### 新闻数据源

| 数据源 | 类型 | 说明 |
|--------|------|------|
| 新浪财经 | RSS/页面 | 财经新闻 |
| 东方财富 | API | 基金快讯 |

## 配置存储

### 目录结构

```
~/.fund-tui/
├── config.yaml          # 主配置（刷新频率、主题等）
├── funds.yaml           # 基金持仓配置
├── commodities.yaml     # 商品关注列表
└── news.yaml            # 新闻源配置
```

### funds.yaml 示例

```yaml
watchlist:
  - code: "161725"
    name: "招商中证白酒指数(LOF)A"

holdings:
  - code: "161039"
    name: "富国中证1000ETF联接A"
    shares: 10000.00
    cost: 1.5000
```

### commodities.yaml 示例

```yaml
commodities:
  - symbol: "XAUUSD"
    name: "国际金价"
    source: "alpha_vantage"

  - symbol: "AUG9999"
    name: "Au99.99"
    source: "akshare"

  - symbol: "WTI"
    name: "WTI原油"
    source: "akshare"
```

## 核心功能

1. 实时刷新基金估值数据（30秒自动刷新）
2. 添加/删除自选基金
3. 显示涨跌幅、净值、估值
4. 标记持有份额
5. 持仓盈亏计算
6. 多数据源自动切换
7. 历史数据图表
8. 大宗商品独立分区
9. 财经新闻区

## 快捷键

| 按键 | 功能 |
|------|------|
| `Tab` | 切换视图（基金/商品/新闻） |
| `a` | 添加基金/商品 |
| `d` | 删除基金/商品 |
| `h` | 标记/取消持有 |
| `r` | 手动刷新 |
| `n` | 切换新闻源 |
| `g` | 查看历史图表 |
| `j/k` | 向下/向上滚动 |
| `F1` | 帮助 |
| `q` | 退出当前视图 |
| `Ctrl+C` | 退出程序 |

## 核心模块

```python
# 数据源管理器
class DataSourceManager:
    def get_fund_data(self, code: str) -> FundData:
        # 按优先级尝试数据源

    def get_commodity_data(self, symbol: str) -> CommodityData:
        # 从配置的数据源获取

# 新闻管理器
class NewsManager:
    def fetch_news(self, source: str) -> list[NewsItem]:
        # 从多个新闻源获取

# 配置管理器
class ConfigManager:
    def load_funds(self) -> list[Fund]:
    def save_funds(self, funds: list[Fund]):
    def load_commodities(self) -> list[Commodity]:
```

## 界面布局

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  Fund Real-Time Valuation    [F1]帮助  [F2]刷新  [Tab]切换视图  [Ctrl+C]退出 │
├─────────────────────────────────────────────────────────────────────────────┤
│  [基金] 商品  新闻                                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│  自选基金 (8)  |  大宗商品 (4)  |  财经新闻 (10)                             │
│               |               |                                           │
│  代码      名称        净值     估值     涨跌    持仓盈亏    │  时间    标题                          │
│  ─────────────────────────────────────────────────────────  │  ────────────────────────────────────│
│  161039  富国中证...   1.5234  1.5250  +0.11%  +234.50       │  10:32  A股三大指数集体上涨           │
│  161032  富国中证...   2.4102  2.4080  -0.09%  -121.00       │  10:28  黄金价格突破历史新高          │
│  110022  易方达消费... 3.8765  3.8800  +0.09%  (观察)        │  10:25  央行降准0.25个百分点          │
│  ─────────────────────────────────────────────────────────  │  10:15  基金四季报披露完毕            │
│  金AU99.99  620.50  +0.32%  ←→  WTI原油  64.05  -1.20%     │  10:08  消费板块全线反弹              │
├─────────────────────────────────────────────────────────────────────────────┤
│  总收益: +113.50 (+0.42%)  数据源: 新浪财经  最后刷新: 2026-02-03 10:32:15   │
└─────────────────────────────────────────────────────────────────────────────┘
```

**当前实际布局问题：**
- ❌ 未实现三栏布局（当前为单视图切换）
- ❌ 大宗商品数据未显示（在商品视图中为空）
- ❌ 缺少板块概念
- ❌ 统计面板未正确显示

## 下一步

### 进度追踪

| 任务 | 状态 | 完成日期 | 备注 |
|------|------|----------|------|
| 设置项目结构 | ✅ 已完成 | 2026-02-03 | src/, tests/, docs/ 目录 |
| 创建虚拟环境 | ✅ 已完成 | 2026-02-03 | venv/ |
| 安装依赖 | ✅ 已完成 | 2026-02-03 | requirements.txt |
| 实现 UI 框架 | ✅ 已完成 | 2026-02-03 | app.py, screens.py, widgets.py |
| 实现配置管理器 | ✅ 已完成 | 2026-02-03 | manager.py, models.py |
| 实现数据源管理器 | ✅ 已完成 | 2026-02-03 | manager.py (故障切换、负载均衡) |
| 实现基金数据源 | ✅ 已完成 | 2026-02-03 | fund_source.py (天天基金接口) |
| 实现商品数据源 | ✅ 已完成 | 2026-02-03 | commodity_source.py (YFinance) |
| 实现新闻数据源 | ✅ 已完成 | 2026-02-03 | news_source.py |
| **UI 集成真实数据** | ✅ 已完成 | 2026-02-03 | 基金/商品/新闻数据获取正常 |
| **大宗商品显示修复** | ✅ 已完成 | 2026-02-03 | 修复 YFinance 数据源格式问题 |
| **UI 排版优化** | ✅ 已完成 | 2026-02-03 | 三栏并排布局 (Grid) |
| **行业板块功能** | ✅ 已完成 | 2026-02-03 | 新增 15 个行业板块 |
| 添加/删除基金功能 | ✅ 已完成 | 2026-02-03 | a/d 快捷键实现、AddFundDialog |
| 持仓管理功能 | ✅ 已完成 | 2026-02-03 | h 快捷键、配置文件联动、 HoldingDialog |
| 历史数据图表 | ✅ 已完成 | 2026-02-03 | g 快捷键、ChartDialog、ASCII图表 |
| 测试与优化 | ✅ 已完成 | 2026-02-03 | 异常处理、性能优化、并行获取 |

### 当前问题清单

所有问题已解决 ✅

### 待实现功能

1. **数据源扩展** - 支持更多商品类型(AKShare)
2. **主题自定义** - 用户自定义颜色方案
3. **数据导出** - 导出基金数据为 CSV

---

## 更新日志

### 2026-02-03 (第二次更新)
- **添加/删除基金功能**: a/d 快捷键、AddFundDialog 对话框
- **持仓管理功能**: h 快捷键、HoldingDialog 对话框、funds.yaml 持久化
- **历史数据图表**: g 快捷键、ChartDialog 对话框、ASCII 图表展示
- **异常处理完善**: fund_source 重试、并行获取优化
- **性能优化**: 数据源并行获取、fetch_batch 并行参数
- **UI 优化**: 三栏 Grid 布局 (2fr 1.5fr 1fr)

### 2026-02-03 (本次更新)
- 集成真实数据源到 UI，移除模拟数据
- 基金数据：天天基金接口 (fundgz.1234567.com.cn) ✅ 已验证
- 商品数据：YFinance (黄金) ✅ 已验证
- 新闻数据：新浪财经 ✅ 已验证
- 实现故障切换：数据源失败时自动回退
- 使用多代理并行开发，同时完成 UI 与三个数据源的集成

### 运行验证

```bash
cd "/Users/huangxiang/work/Fund Real-Time Valuation"
source venv/bin/activate
pip install yfinance  # 需要先安装
python run_tui.py     # 启动 TUI 应用
```

### 数据源验证结果

| 数据源 | 接口 | 状态 |
|--------|------|------|
| 天天基金 | fundgz.1234567.com.cn | ✅ 成功 |
| YFinance 黄金 | yfinance | ✅ 成功 |
| 新浪财经 | Sina News RSS | ✅ 成功 |
| AKShare | akshare (需安装) | ⏳ 待安装 |
